input {
  # TCP input for application logs
  tcp {
    port => 5000
    codec => json_lines
    tags => ["lotus-backend"]
  }

  # UDP input for syslog
  udp {
    port => 5000
    codec => json_lines
    tags => ["lotus-backend"]
  }

  # Beats input
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add timestamp
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
    target => "@timestamp"
  }

  # Extract log level
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }

  # Add environment tag
  mutate {
    add_field => {
      "environment" => "${ENVIRONMENT:development}"
      "application" => "lotus-sms"
    }
  }

  # Grok pattern for Spring Boot logs
  if "lotus-backend" in [tags] {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{NUMBER:pid} --- \[%{DATA:thread}\] %{DATA:logger} : %{GREEDYDATA:log_message}"
      }
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "input" ]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "lotus-sms-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Output to console for debugging (optional)
  # stdout {
  #   codec => rubydebug
  # }
}
