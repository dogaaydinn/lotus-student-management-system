# Enterprise Configuration Profile
# Extends base application.yml with enterprise features

spring:
  profiles:
    active: enterprise
    include: base

  # Kafka Configuration
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    consumer:
      group-id: lotus-spm-consumer
      auto-offset-reset: earliest
      enable-auto-commit: false
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3

  # RabbitMQ Configuration
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}
    virtual-host: /
    listener:
      simple:
        acknowledge-mode: manual
        concurrency: 3
        max-concurrency: 10
        prefetch: 50

  # Elasticsearch Configuration
  elasticsearch:
    rest:
      uris: ${ELASTICSEARCH_URIS:http://localhost:9200}
      username: ${ELASTICSEARCH_USERNAME:}
      password: ${ELASTICSEARCH_PASSWORD:}
      connection-timeout: 10s
      read-timeout: 30s

  # Cache Configuration (Multi-level)
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=10000,expireAfterWrite=5m,expireAfterAccess=3m,recordStats
    cache-names:
      - students
      - instructors
      - coordinators
      - opportunities
      - documents
      - messages
      - notifications
      - analytics

  # Hazelcast Configuration
  hazelcast:
    enabled: true

  # OAuth2 Resource Server
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${OAUTH2_ISSUER_URI:}
          jwk-set-uri: ${OAUTH2_JWK_SET_URI:}

# AWS Configuration
aws:
  region: ${AWS_REGION:us-east-1}
  access-key-id: ${AWS_ACCESS_KEY_ID:}
  secret-access-key: ${AWS_SECRET_ACCESS_KEY:}
  s3:
    bucket: ${AWS_S3_BUCKET:lotus-spm-documents}
  sns:
    topic:
      email: ${AWS_SNS_EMAIL_TOPIC:}
      sms: ${AWS_SNS_SMS_TOPIC:}

# Distributed Tracing Configuration
tracing:
  jaeger:
    endpoint: ${JAEGER_ENDPOINT:http://localhost:14250}
    service-name: ${spring.application.name}
    sampler:
      type: probabilistic
      param: 1.0 # 100% sampling for development

# Feature Flags (Togglz)
togglz:
  enabled: true
  feature-enums: com.lotus.lotusSPM.featureflags.FeatureFlags
  console:
    enabled: true
    path: /togglz-console
    secured: true

# GraphQL Configuration
graphql:
  servlet:
    mapping: /graphql
    enabled: true
  graphiql:
    enabled: true
    mapping: /graphiql
    endpoint: /graphql

# WebSocket Configuration
websocket:
  allowed-origins: ${WEBSOCKET_ALLOWED_ORIGINS:*}
  stomp:
    broker:
      relay:
        enabled: false # Use simple broker for development
        host: localhost
        port: 61613

# Quartz Scheduler
quartz:
  job-store-type: jdbc
  properties:
    org:
      quartz:
        scheduler:
          instanceName: LotusScheduler
          instanceId: AUTO
        threadPool:
          threadCount: 10
        jobStore:
          class: org.quartz.impl.jdbcjobstore.JobStoreTX
          driverDelegateClass: org.quartz.impl.jdbcjobstore.StdJDBCDelegate
          isClustered: true
          clusterCheckinInterval: 20000

# Actuator - Enhanced for Enterprise
management:
  endpoints:
    web:
      exposure:
        include: "*" # Expose all endpoints in enterprise mode
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      show-components: always
      probes:
        enabled: true
      group:
        readiness:
          include: readinessState,db,redis,diskSpace
        liveness:
          include: livenessState,ping
  metrics:
    export:
      prometheus:
        enabled: true
        step: 1m
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active}
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.95,0.99
  tracing:
    sampling:
      probability: 1.0

# Logging - Enhanced for Enterprise
logging:
  level:
    root: INFO
    com.lotus.lotusSPM: DEBUG
    org.springframework.web: INFO
    org.springframework.security: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    io.opentelemetry: INFO
    org.axonframework: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg - %X{traceId:-} %X{spanId:-}%n"
  file:
    name: logs/lotus-spm.log
    max-size: 10MB
    max-history: 30
    total-size-cap: 1GB

# Resilience4j - Enhanced Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
    instances:
      studentService:
        baseConfig: default
      opportunityService:
        baseConfig: default
        failureRateThreshold: 60

  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 1000
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.io.IOException
    instances:
      studentService:
        baseConfig: default

  ratelimiter:
    configs:
      default:
        limitForPeriod: 100
        limitRefreshPeriod: 1s
        timeoutDuration: 0
    instances:
      studentService:
        baseConfig: default

  bulkhead:
    configs:
      default:
        maxConcurrentCalls: 25
        maxWaitDuration: 100ms
    instances:
      studentService:
        baseConfig: default

# OpenAPI / Swagger Configuration
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operationsSorter: method
    tagsSorter: alpha
    displayRequestDuration: true
    filter: true
    showExtensions: true
  show-actuator: true
  group-configs:
    - group: public-api
      paths-to-match: /api/v1/**
      packages-to-scan: com.lotus.lotusSPM.web
    - group: admin-api
      paths-to-match: /api/admin/**
      packages-to-scan: com.lotus.lotusSPM.web
    - group: graphql-api
      paths-to-match: /graphql/**

# Performance and Tuning
server:
  tomcat:
    threads:
      max: 200
      min-spare: 10
    connection-timeout: 20000
    max-connections: 10000
    accept-count: 100
    max-http-header-size: 8KB
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml
    min-response-size: 1024

# Custom Application Properties
app:
  async:
    core-pool-size: 5
    max-pool-size: 50
    queue-capacity: 1000

  bulk-operations:
    batch-size: 1000
    max-file-size: 10MB

  rate-limiting:
    enabled: true
    anonymous:
      limit: 10
      duration: 1m
    authenticated:
      limit: 100
      duration: 1m
    premium:
      limit: 1000
      duration: 1m

  feature-flags:
    enabled: true

  monitoring:
    metrics:
      enabled: true
      export-interval: 60s
    tracing:
      enabled: true
      sampling-rate: 1.0
